#
# %sqlite-linux.yml
#

name: Sqlite Linux ODBC


on:
  push:
    branches:
      - master
      - sqlite
  pull_request:
    branches:
      - master
      - sqlite
  workflow_dispatch:  # Allows running this workflow manually from Actions tab


jobs:
  sqlite-linux-odbc:

    runs-on: ubuntu-latest

    steps:

  #====# ACCELERATE APT INSTALL STEPS #=======================================#

    - name: Divert mandb to No-Op (speeds up apt significantly)
      run: |
        sudo dpkg-divert --local --rename --add /usr/bin/mandb
        echo -e '#!/bin/sh\nexit 0' | sudo tee /usr/bin/mandb > /dev/null
        sudo chmod +x /usr/bin/mandb


  #====# CHECKOUT STEPS #=====================================================#

    # https://github.com/actions/checkout
    #
    # See README: Checkout Action
    #
    - uses: actions/checkout@v3  # See README: Trusted Actions


  #====# SQLITE-ODBC INSTALLATION #===========================================#

    - name: Install Sqlite
      run: |
        sudo apt install -y sqlite3


    - name: Install ODBC
      run: |
        sudo apt install -y unixodbc libodbc2 odbcinst


    - name: Install SQLite ODBC Driver
      run: |
        sudo apt install -y libsqliteodbc


    - name: Register DSN
      run: |
        echo "[rebol-sqlite]
        Description=SQLite ODBC
        Driver=SQLite3
        Database=$(pwd)/test.db
        " | sudo tee -a /etc/odbc.ini


      # You need to run some command to get the database to be created.  This
      # seems the best answer in terms of actually creating a non-0 size file
      # that is most obviously "a SQLite database", while still being empty.
      #
      # https://stackoverflow.com/a/51455470
      #
    - name: Create Sqlite Database File test.db
      run: |
        sqlite3 test.db "VACUUM;"


  #====# SANITY CHECK ODBC #=================================================#

    - name: Sanity Check ODBC
      run: |
        bash -e tools/sanity-check-odbc.sh


  #====# INSTALL R3 INTERPRETER #=============================================#

    - name: Download and Cache the Interpreter
      uses: metaeducation/ren-c-action@release
      with:
        checked: true


  #====# TEST STEPS #==========================================================#

    # The tests are designed to call QUIT and return 1 status on failure, with
    # 0 returned on success.

    # For starters, this is a basic insert and retrieve test of Rebol values.
    # The goal is to store Rebol values into column types that can hold them,
    # and then read the same value back out after writing it.
    #
    # This runs against the DSNs of the MySQL database created above.
    # the process above.
    #
    - name: ODBC Sqlite Insert And Retrieve Test
      run: |
        r3 tests/odbc-test.r rebol-sqlite --sqlite


    - name: ODBC Test Without Closing Connection
      run: |
        r3 tests/odbc-test.r rebol-sqlite --sqlite --leave-connected
